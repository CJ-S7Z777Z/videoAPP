<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мини-приложение</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Подключение стилей -->
    <style>
        /* Общие стили */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #FFFFFF;
            overflow: hidden;
            height: 100vh;
        }

        /* Скрытый контент до загрузки */
        .hidden {
            display: flex;
        }


        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Плавная подсветка (градиент) */
        #gradient {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            box-shadow: 0px 0px 30px 10px transparent;
            animation: gradientGlow 15s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes gradientGlow {
            0% { box-shadow: 0px 0px 30px 10px #FF3B30; }
            25% { box-shadow: 0px 0px 30px 10px #1DB954; }
            50% { box-shadow: 0px 0px 30px 10px #1E90FF; }
            75% { box-shadow: 0px 0px 30px 10px #FFA500; }
            100% { box-shadow: 0px 0px 30px 10px #FF69B4; }
        }

        /* Главный контент */
        #app-content {
            padding: 20px;
            padding-top: 60px; /* Отступ сверху для безопасной зоны */
            overflow-y: auto; /* Добавлено для скроллинга */
            height: calc(100vh - 60px); /* Высота контента с учетом navbar */
        }

        /* Профиль пользователя */
        .profile {
            display: flex;
            align-items: center;
            padding: 20px;
        }

        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #1DB954;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: #FFFFFF;
            margin-right: 15px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
        }

        .user-info h2, .user-info p {
            margin: 0;
        }

        /* Остаток по тарифу */
        .balance-section {
            text-align: center;
            margin-top: 30px;
        }

        #no-tariff-banner {
            background-color: #FF3B30;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        #balance-info h1 {
            font-size: 48px;
            margin: 0;
        }

        #balance-info p {
            margin: 5px 0;
        }

        /* Статус */
        #status {
            color: #FF3B30; /* Красный по умолчанию (Неактивен) */
            font-weight: bold;
        }

        #status.active {
            color: #4CD964; /* Зеленый (Активен) */
        }

        /* Навигационная панель */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1E1E1E;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }

        .nav-button {
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 16px;
            flex-grow: 1;
            padding: 10px 0;
            cursor: pointer;
            position: relative;
        }

        .nav-button.active {
            border-top: 2px solid #1DB954;
            color: #1DB954;
        }

        .notification-counter {
            display: inline-block;
            background-color: red;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
            position: absolute;
            top: 5px;
            right: 15px;
        }

        /* Переключатель */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            background-color: #ccc;
            border-radius: 34px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CD964;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Страница настроек */
        .settings {
            padding: 20px;
            padding-top: 60px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            cursor: pointer;
            position: relative;
        }

        /* Кнопка "Назад" */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 24px;
            cursor: pointer;
            z-index: 2;
        }

        /* Секция тарифов */
        .tariff-card {
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .tariff-card:hover {
            background-color: #2A2A2A;
        }

        .tariff-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #333333;
            margin-right: 15px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .tariff-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tariff-info {
            flex-grow: 1;
        }

        .tariff-info h3 {
            margin: 0;
            font-size: 18px;
        }

        .tariff-info p {
            margin: 5px 0;
            color: #AAAAAA;
        }

        .tariff-price {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .tariff-action {
            margin-left: 10px;
        }

        .tariff-button {
            padding: 10px 15px;
            background-color: #1DB954;
            border: none;
            border-radius: 5px;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tariff-button:hover {
            background-color: #17A44A;
        }

        .tariff-button:active {
            background-color: #14803D;
        }

        /* Дополнительные стили */
        h2, h1 {
            margin: 0;
        }

        /* Обеспечение безопасной зоны */
        #app-content {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .navbar {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* История действий */
        .history-section {
            margin-top: 30px;
        }

        .history-item {
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .history-item:hover {
            background-color: #2A2A2A;
        }

        .history-item h3 {
            margin: 0;
            font-size: 16px;
        }

        .history-item p {
            margin: 5px 0;
            color: #AAAAAA;
            font-size: 14px;
        }

        /* Уведомление */
        .notification-banner {
            position: fixed;
            top: 10%;
            left: 5%;
            right: 5%;
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(-100%);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification-banner.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification-banner p {
            margin: 5px 0;
        }

        .notification-accept-button {
            color: #1DB954;
            font-weight: bold;
            cursor: pointer;
            float: right;
        }

        /* Страница уведомлений */
        .notifications-list {
            padding: 20px;
            padding-top: 60px;
        }

        .notification-item {
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #2A2A2A;
        }

        .notification-item h3 {
            margin: 0;
            font-size: 16px;
        }

        .notification-item p {
            margin: 5px 0;
            color: #AAAAAA;
            font-size: 14px;
        }

        .unread-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: red;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
        }

        /* Попап для подробной информации */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .popup-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1E1E1E;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            overflow: hidden;
        }

        .popup-content h3 {
            margin-top: 0;
        }

        .popup-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 24px;
            cursor: pointer;
        }

        .popup-content a {
            color: #1E90FF;
            text-decoration: none;
        }

        .popup-content a:hover {
            text-decoration: underline;
        }

        /* Кнопка "Прочитать все" */
        .mark-all-read-button {
            padding: 10px 15px;
            background-color: #1DB954;
            border: none;
            border-radius: 5px;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 20px;
        }

        .mark-all-read-button:hover {
            background-color: #17A44A;
        }

        .mark-all-read-button:active {
            background-color: #14803D;
        }

    </style>

    <!-- Инициализация Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Анимация загрузки -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Основной контент -->
    <div id="app" class="hidden">
        <!-- Плавная подсветка (градиент) -->
        <div id="gradient"></div>

        <!-- Контент приложения -->
        <div id="app-content">
            <!-- Здесь будет динамически меняться содержимое -->
        </div>

        <!-- Навигационная панель -->
        <div class="navbar">
            <button class="nav-button active" id="nav-home">Главная</button>
            <button class="nav-button" id="nav-tariffs">Тарифы</button>
            <!-- Удалена кнопка "История" -->
            <button class="nav-button" id="nav-profile">Профиль</button>
            <button class="nav-button" id="nav-settings">Настройки</button>
        </div>
    </div>

    <!-- Скрипт для логики приложения -->
    <script>

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    // Проверка наличия Telegram Web App или создание заглушки для тестирования в браузере
    let tg = window.Telegram ? window.Telegram.WebApp : null;

    if (!tg) {
        // Заглушка для тестирования в браузере
        tg = {
            initDataUnsafe: {
                user: {
                    first_name: 'Тест',
                    last_name: 'Пользователь',
                    username: 'testuser',
                    photo_url: ''
                }
            },
            expand: function() {},
            requestFullscreen: function() {},
            onEvent: function() {},
            safeAreaInset: {top: 0, bottom: 0},
            isActive: true,
            isFullscreen: true,
            sendData: function(data) {
                console.log('Отправка данных боту:', data);
            }
        };
        console.warn('Telegram WebApp не найден. Используется заглушка для тестирования.');
    }

    // Оборачиваем код в try...catch для отлова ошибок
    try {
        // Устанавливаем полноэкранный режим
        tg.expand();
        tg.requestFullscreen();

        //Получаем элементы DOM
        const loader = document.getElementById('loader');
        const app = document.getElementById('app');
        const appContent = document.getElementById('app-content');
        const gradientElem = document.getElementById('gradient');

        // Настройки пользователя
        let isHighlightEnabled = localStorage.getItem('isHighlightEnabled') === 'false' ? false : true;

        // Данные пользователя
        const initData = tg.initDataUnsafe.user || {};
        const userFirstName = initData.first_name || 'Имя';
        const userLastName = initData.last_name || '';
        const username = initData.username ? '@' + initData.username : '';
        const userPhoto = initData.photo_url || '';

        // Данные о тарифе пользователя
        let userBalance = 0; // Получить из бота через API
        let userStatus = 'Неактивен';
        let userTariff = '—';

        // История действий пользователя
        let userHistory = []; // Получить из бота через API

        // Массив уведомлений
        let notifications = [];

        // Переменная с юзернеймом менеджера поддержки
        const managerUsername = 'https://t.me/mwii_boss'; // Замените на актуальный юзернейм

        // Функция обновления информации о тарифе
        function updateTariffInfo() {
            if (userBalance > 0) {
                userStatus = 'Активен';
            } else {
                userStatus = 'Неактивен';
                userTariff = '—';
            }
        }

        // Функция для обновления истории действий
        function updateUserHistory() {
            // Здесь вы можете сделать запрос к боту или серверу для получения истории
            // Для примера используем статический массив
            userHistory = [
                {
                    type: 'download',
                    source: 'YouTube',
                    title: 'Видео 1',
                    link: 'https://youtu.be/video1',
                    size: 50,
                    date: '2023-10-01 12:00'
                },
                {
                    type: 'subscription',
                    tariffName: 'Пробный',
                    quantity: 100,
                    price: '399₽',
                    date: '2023-10-02 14:30'
                },
                {
                    type: 'publication',
                    groupName: 'Группа ВК',
                    date: '2023-10-03 16:45'
                }
            ];
        }

        // Функция обновления счетчика уведомлений
        function updateNotificationsCounter() {
            // Получаем количество непрочитанных уведомлений
            const unreadCount = notifications.filter(n => !n.read).length;

            // Получаем кнопку "Настройки" из навигации
            const settingsButton = document.getElementById('nav-settings');

            // Проверяем, есть ли уже элемент счетчика
            let counterElem = settingsButton.querySelector('.notification-counter');

            if (unreadCount > 0) {
                if (!counterElem) {
                    // Создаем новый элемент счетчика
                    counterElem = document.createElement('span');
                    counterElem.className = 'notification-counter';
                    settingsButton.appendChild(counterElem);
                }
                counterElem.textContent = unreadCount;
            } else {
                // Если счетчик существует, удаляем его
                if (counterElem) {
                    counterElem.remove();
                }
            }
        }

        // Функция переключения подсветки
        function toggleHighlight() {
            if (isHighlightEnabled) {
                gradientElem.style.display = 'block';
            } else {
                gradientElem.style.display = 'none';
            }
        }

        // Функция обновления безопасных зон
        function updateSafeArea() {
            const safeArea = tg.safeAreaInset;
            const topPadding = (safeArea.top || 0) + 20;
            const bottomPadding = (safeArea.bottom || 0) + 20;
            appContent.style.paddingTop = topPadding + 'px';
            appContent.style.paddingBottom = bottomPadding + 'px';
        }

        // Функция рендеринга основного контента
        function navigateTo(pageId) {
            appContent.innerHTML = ''; // Очищаем контент

            // Добавляем кнопку "Назад" для страниц кроме главной и уведомлений
            if (pageId !== 'nav-home' && pageId !== 'nav-notifications') {
                const backButton = document.createElement('button');
                backButton.className = 'back-button';
                backButton.innerHTML = '←';
                backButton.addEventListener('click', () => {
                    navigateTo('nav-home');
                    document.getElementById('nav-home').classList.add('active');
                    const activeButtons = document.querySelectorAll('.nav-button.active');
                    activeButtons.forEach(btn => {
                        if (btn.id !== 'nav-home') btn.classList.remove('active');
                    });
                });
                appContent.appendChild(backButton);
            }

            switch (pageId) {
                case 'nav-home':
                    renderHomePage();
                    break;
                case 'nav-tariffs':
                    renderTariffsPage();
                    break;
                case 'nav-profile':
                    renderProfilePage();
                    break;
                case 'nav-settings':
                    renderSettingsPage();
                    break;
                case 'nav-notifications':
                    renderNotificationsPage();
                    break;
                default:
                    renderHomePage();
            }
        }

        // Функция рендеринга главной страницы
        function renderHomePage() {
            updateTariffInfo();
            updateUserHistory(); // Обновляем историю действий

            // Остаток по тарифу
            const balanceSection = document.createElement('div');
            balanceSection.className = 'balance-section';

            // Плашка при отсутствии тарифа
            if (userBalance === 0) {
                const noTariffBanner = document.createElement('div');
                noTariffBanner.id = 'no-tariff-banner';
                noTariffBanner.innerHTML = 'У вас не оформлен тариф. Перейдите в раздел <strong>"Тарифы"</strong>.';
                noTariffBanner.addEventListener('click', () => {
                    document.getElementById('nav-tariffs').click();
                });
                balanceSection.appendChild(noTariffBanner);
            }

            // Информация о балансе
            const balanceInfo = document.createElement('div');
            balanceInfo.id = 'balance-info';

            const balanceElem = document.createElement('h1');
            balanceElem.id = 'balance';
            balanceElem.textContent = `${userBalance} видео`;
            balanceInfo.appendChild(balanceElem);

            const statusElem = document.createElement('p');
            statusElem.id = 'status';
            statusElem.textContent = userStatus;
            if (userStatus === 'Активен') {
                statusElem.classList.add('active');
            }
            balanceInfo.appendChild(statusElem);

            const tariffNameElem = document.createElement('p');
            tariffNameElem.id = 'tariff-name';
            tariffNameElem.textContent = `Тариф: ${userTariff}`;
            balanceInfo.appendChild(tariffNameElem);

            balanceSection.appendChild(balanceInfo);

            appContent.appendChild(balanceSection);

            // Добавляем раздел "История"
            const historySection = document.createElement('div');
            historySection.className = 'history-section';

            const historyTitle = document.createElement('h2');
            historyTitle.textContent = 'История';
            historySection.appendChild(historyTitle);

            // Проверяем наличие действий в истории
            if (userHistory.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.textContent = 'Пока нет действий.';
                historySection.appendChild(emptyMessage);
            } else {
                userHistory.forEach(item => {
                    const actionItem = document.createElement('div');
                    actionItem.className = 'history-item';

                    const itemTitle = document.createElement('h3');
                    if (item.type === 'download') {
                        itemTitle.textContent = `Скачано видео: ${item.title}`;
                    } else if (item.type === 'subscription') {
                        itemTitle.textContent = `Оформлен тариф: ${item.tariffName}`;
                    } else if (item.type === 'publication') {
                        itemTitle.textContent = `Публикация в группе`;
                    }
                    actionItem.appendChild(itemTitle);

                    const itemDate = document.createElement('p');
                    itemDate.textContent = `Дата: ${item.date}`;
                    actionItem.appendChild(itemDate);

                    // Добавляем обработчик клика для отображения подробной информации
                    actionItem.addEventListener('click', () => {
                        showActionDetails(item);
                    });

                    historySection.appendChild(actionItem);
                });
            }

            appContent.appendChild(historySection);
        }

        // Функция отображения подробной информации о действии
        function showActionDetails(item) {
            // Создаем затемненный фон
            const overlay = document.createElement('div');
            overlay.className = 'popup-overlay';
            overlay.addEventListener('click', () => {
                overlay.remove();
            });

            // Создаем окно попапа
            const popup = document.createElement('div');
            popup.className = 'popup-content';
            popup.addEventListener('click', (e) => {
                e.stopPropagation(); // Останавливаем всплытие события, чтобы клик внутри попапа не закрывал его
            });

            // Кнопка закрытия
            const closeButton = document.createElement('button');
            closeButton.className = 'popup-close-button';
            closeButton.innerHTML = '&times;';
            closeButton.addEventListener('click', () => {
                overlay.remove();
            });
            popup.appendChild(closeButton);

            if (item.type === 'download') {
                const title = document.createElement('h3');
                title.textContent = `Скачанное видео: ${item.title}`;
                popup.appendChild(title);

                const source = document.createElement('p');
                source.textContent = `Источник: ${item.source}`;
                popup.appendChild(source);

                const link = document.createElement('p');
                link.innerHTML = `Ссылка: <a href="${item.link}" target="_blank">${item.link}</a>`;
                popup.appendChild(link);

                const size = document.createElement('p');
                size.textContent = `Размер: ${item.size} МБ`;
                popup.appendChild(size);

                const date = document.createElement('p');
                date.textContent = `Дата скачивания: ${item.date}`;
                popup.appendChild(date);
            } else if (item.type === 'subscription') {
                const title = document.createElement('h3');
                title.textContent = `Тариф: ${item.tariffName}`;
                popup.appendChild(title);

                const quantity = document.createElement('p');
                quantity.textContent = `Количество видео: ${item.quantity}`;
                popup.appendChild(quantity);

                const price = document.createElement('p');
                price.textContent = `Цена: ${item.price}`;
                popup.appendChild(price);

                const date = document.createElement('p');
                date.textContent = `Время покупки: ${item.date}`;
                popup.appendChild(date);
            } else if (item.type === 'publication') {
                const title = document.createElement('h3');
                title.textContent = `Публикация в группе`;
                popup.appendChild(title);

                const groupName = document.createElement('p');
                groupName.textContent = `Название группы: ${item.groupName}`;
                popup.appendChild(groupName);

                const date = document.createElement('p');
                date.textContent = `Время публикации: ${item.date}`;
                popup.appendChild(date);
            }

            overlay.appendChild(popup);
            document.body.appendChild(overlay);
        }

        // Функция рендеринга страницы "Тарифы"
        function renderTariffsPage() {
            const tariffsDiv = document.createElement('div');
            tariffsDiv.style.padding = '20px';
            tariffsDiv.style.paddingTop = '60px';

            const title = document.createElement('h2');
            title.textContent = 'Тарифы';
            title.style.marginBottom = '20px';
            tariffsDiv.appendChild(title);

            // Массив тарифов
            const tariffs = [
                {
                    name: 'Пробный',
                    description: 'Для скачивания доступно 100 видео',
                    price: '399₽',
                    image: '', // Добавьте ссылки на изображения тарифов
                    action: 'Оформить',
                    quantity: 100
                },
                {
                    name: 'Новичок',
                    description: 'Для скачивания доступно 500 видео',
                    price: '1799₽',
                    image: '',
                    action: 'Оформить',
                    quantity: 500
                },
                {
                    name: 'Любитель',
                    description: 'Для скачивания доступно 1000 видео',
                    price: '2999₽',
                    image: '',
                    action: 'Оформить',
                    quantity: 1000
                },
                {
                    name: 'Профи',
                    description: 'Для скачивания доступно 2000 видео',
                    price: '5499₽',
                    image: '',
                    action: 'Оформить',
                    quantity: 2000
                },
                {
                    name: 'Бизнес',
                    description: 'Для скачивания доступно 3000 видео',
                    price: '6999₽',
                    image: '',
                    action: 'Оформить',
                    quantity: 3000
                },
                {
                    name: 'Бизнес VIP',
                    description: 'Для скачивания доступно более 3000 видео',
                    price: 'По договоренности',
                    image: '',
                    action: 'Связаться',
                    quantity: 5000 // Предположим
                }
            ];

            tariffs.forEach(tariff => {
                const card = document.createElement('div');
                card.className = 'tariff-card';

                const image = document.createElement('div');
                image.className = 'tariff-image';
                // Если есть картинка, установить как фон
                if (tariff.image) {
                    const img = document.createElement('img');
                    img.src = tariff.image;
                    image.appendChild(img);
                }
                card.appendChild(image);

                const info = document.createElement('div');
                info.className = 'tariff-info';

                const name = document.createElement('h3');
                name.textContent = tariff.name;
                info.appendChild(name);

                const description = document.createElement('p');
                description.textContent = tariff.description;
                info.appendChild(description);

                const price = document.createElement('div');
                price.className = 'tariff-price';
                price.textContent = tariff.price;
                info.appendChild(price);

                card.appendChild(info);

                const actionDiv = document.createElement('div');
                actionDiv.className = 'tariff-action';

                const button = document.createElement('button');
                button.className = 'tariff-button';
                button.textContent = tariff.action;
                button.addEventListener('click', () => {
                    if (tariff.action === 'Связаться') {
                        // Открыть чат с менеджером
                        tg.sendData(JSON.stringify({action: 'contact_manager', username: managerUsername}));
                    } else {
                        // Активировать тариф
                        startPayment(tariff);
                    }
                });
                actionDiv.appendChild(button);

                card.appendChild(actionDiv);

                tariffsDiv.appendChild(card);
            });

            appContent.appendChild(tariffsDiv);
        }

        // Функция для имитации активации тарифа
        function startPayment(tariff) {
            // Обновляем баланс пользователя
            userBalance += tariff.quantity;

            // Обновляем имя тарифа
            userTariff = tariff.name;

            // Обновляем статус пользователя
            userStatus = 'Активен';

            // Обновляем информацию о тарифе
            updateTariffInfo();

            // Добавляем действие в историю
            const subscriptionAction = {
                type: 'subscription',
                tariffName: tariff.name,
                quantity: tariff.quantity,
                price: tariff.price,
                date: new Date().toLocaleString()
            };
            userHistory.unshift(subscriptionAction);

            // Создаем уведомление
            let notification = {
                id: Date.now(),
                title: `Вы оформили тариф ${tariff.name}`,
                message: `Доступно для скачивания ${tariff.quantity} видео`,
                read: false,
                timestamp: Date.now()
            };

            // Добавляем уведомление в массив
            notifications.push(notification);

            // Обновляем счетчик уведомлений
            updateNotificationsCounter();

            // Показываем уведомление
            showNotificationBanner(notification);

            // Переходим на главную страницу
            navigateTo('nav-home');
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('nav-home').classList.add('active');
        }

        // Функция рендеринга страницы "Профиль"
        function renderProfilePage() {
            const profileDiv = document.createElement('div');
            profileDiv.style.padding = '20px';
            profileDiv.style.paddingTop = '60px';

            const profileSection = document.createElement('div');
            profileSection.className = 'profile';

            const avatarElem = document.createElement('div');
            avatarElem.className = 'avatar';

            if (userPhoto) {
                const img = document.createElement('img');
                img.src = userPhoto;
                avatarElem.appendChild(img);
            } else {
                avatarElem.textContent = userFirstName.charAt(0).toUpperCase();
            }

            profileSection.appendChild(avatarElem);

            const userInfoDiv = document.createElement('div');
            userInfoDiv.className = 'user-info';

            const nameElem = document.createElement('h2');
            nameElem.textContent = `${userFirstName} ${userLastName}`.trim();
            userInfoDiv.appendChild(nameElem);

            const usernameElem = document.createElement('p');
            usernameElem.textContent = username;
            userInfoDiv.appendChild(usernameElem);

            profileSection.appendChild(userInfoDiv);

            profileDiv.appendChild(profileSection);

            appContent.appendChild(profileDiv);
        }

        // Функция рендеринга страницы "Настройки"
        function renderSettingsPage() {
            const settingsDiv = document.createElement('div');
            settingsDiv.className = 'settings';

            // Уведомления
            const notificationsSetting = document.createElement('div');
            notificationsSetting.className = 'settings-item';
            notificationsSetting.style.cursor = 'pointer';

            const notificationsLabel = document.createElement('span');
            notificationsLabel.textContent = 'Уведомления';

            // Проверяем количество непрочитанных уведомлений
            const unreadCount = notifications.filter(n => !n.read).length;

            if (unreadCount > 0) {
                const notificationsCounterElem = document.createElement('span');
                notificationsCounterElem.className = 'notification-counter';
                notificationsCounterElem.textContent = unreadCount;
                notificationsSetting.appendChild(notificationsCounterElem);
            }

            notificationsSetting.appendChild(notificationsLabel);

            // Обработчик клика для открытия страницы уведомлений
            notificationsSetting.addEventListener('click', () => {
                navigateTo('nav-notifications');
            });

            settingsDiv.appendChild(notificationsSetting);

            // Настройка "Подсветка"
            const highlightSetting = document.createElement('div');
            highlightSetting.className = 'settings-item';

            const settingLabel = document.createElement('span');
            settingLabel.textContent = 'Подсветка';

            const switchLabel = document.createElement('label');
            switchLabel.className = 'switch';

            const switchInput = document.createElement('input');
            switchInput.type = 'checkbox';
            switchInput.checked = isHighlightEnabled;
            switchInput.addEventListener('change', () => {
                isHighlightEnabled = switchInput.checked;
                localStorage.setItem('isHighlightEnabled', isHighlightEnabled);
                toggleHighlight();
            });

            const switchSlider = document.createElement('span');
            switchSlider.className = 'slider';

            switchLabel.appendChild(switchInput);
            switchLabel.appendChild(switchSlider);

            highlightSetting.appendChild(settingLabel);
            highlightSetting.appendChild(switchLabel);

            settingsDiv.appendChild(highlightSetting);

            // Добавляем плашку "Поддержка"
            const supportSetting = document.createElement('div');
            supportSetting.className = 'settings-item';
            supportSetting.style.cursor = 'pointer';

            const supportLabel = document.createElement('span');
            supportLabel.textContent = 'Поддержка';

            supportSetting.appendChild(supportLabel);

            // Добавляем обработчик события для открытия чата с менеджером
            supportSetting.addEventListener('click', () => {
                tg.sendData(JSON.stringify({action: 'contact_manager', username: managerUsername}));
            });

            settingsDiv.appendChild(supportSetting);

            appContent.appendChild(settingsDiv);
        }

        // Функция рендеринга страницы "Уведомления"
        function renderNotificationsPage() {
            appContent.innerHTML = ''; // Очищаем контент

            // Добавляем кнопку "Назад"
            const backButton = document.createElement('button');
            backButton.className = 'back-button';
            backButton.innerHTML = '←';
            backButton.addEventListener('click', () => {
                navigateTo('nav-settings');
                document.getElementById('nav-settings').classList.add('active');
                document.getElementById('nav-notifications').classList.remove('active');
            });
            appContent.appendChild(backButton);

            // Заголовок
            const title = document.createElement('h2');
            title.textContent = 'Уведомления';
            title.style.margin = '20px';
            appContent.appendChild(title);

            // Кнопка "Прочитать все"
            const markAllReadButton = document.createElement('button');
            markAllReadButton.className = 'mark-all-read-button';
            markAllReadButton.textContent = 'Прочитать все';
            markAllReadButton.addEventListener('click', () => {
                notifications.forEach(n => n.read = true);
                updateNotificationsCounter();
                renderNotificationsPage(); // Обновляем страницу
            });
            appContent.appendChild(markAllReadButton);

            // Список уведомлений
            const notificationsList = document.createElement('div');
            notificationsList.className = 'notifications-list';

            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = 'notification-item';

                const notificationTitle = document.createElement('h3');
                notificationTitle.textContent = notification.title;
                notificationItem.appendChild(notificationTitle);

                const notificationMessage = document.createElement('p');
                notificationMessage.textContent = notification.message;
                notificationItem.appendChild(notificationMessage);

                if (!notification.read) {
                    const unreadIndicator = document.createElement('span');
                    unreadIndicator.className = 'unread-indicator';
                    unreadIndicator.textContent = 'Непрочитано';
                    notificationItem.appendChild(unreadIndicator);
                }

                notificationItem.addEventListener('click', () => {
                    notification.read = true;
                    updateNotificationsCounter();
                    renderNotificationsPage();
                });

                notificationsList.appendChild(notificationItem);
            });

            appContent.appendChild(notificationsList);
        }

        // Навигационные кнопки
        const navButtons = document.querySelectorAll('.nav-button');
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                navigateTo(button.id);
            });
        });

        // Изначально устанавливаем состояние подсветки
        toggleHighlight();

        // Обработка безопасных зон
        tg.onEvent('safeAreaChanged', updateSafeArea);
        tg.onEvent('viewportChanged', updateSafeArea);

        updateSafeArea();

        // Убираем загрузчик и показываем приложение
        setTimeout(() => {
            if (loader) loader.classList.add('hidden');
            if (app) app.classList.remove('hidden');
            navigateTo('nav-home'); // Переходим на главную страницу
        }, 500); // Имитируем загрузку данных

    } catch (error) {
        console.error('Произошла ошибка:', error);
    }
});

    </script>
</body>
</html>
