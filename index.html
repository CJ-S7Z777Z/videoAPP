<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Мини-приложение</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Инициализация Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- Подключение стилей и скриптов -->
    <style>
        /* Ваши стили CSS остаются без изменений */
        /* Общие стили */
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: #121212;
            color: #FFFFFF;
            overflow: hidden;
            height: 100vh;
        }

        /* Скрытый контент до загрузки */
        .hidden {
            display: flex;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Плавная подсветка (градиент) */
        #gradient {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 20px;
            box-shadow: 0px 0px 30px 10px transparent;
            animation: gradientGlow 15s ease-in-out infinite;
            z-index: 1;
        }

        @keyframes gradientGlow {
            0% { box-shadow: 0px 0px 30px 10px #FF3B30; }
            25% { box-shadow: 0px 0px 30px 10px #1DB954; }
            50% { box-shadow: 0px 0px 30px 10px #1E90FF; }
            75% { box-shadow: 0px 0px 30px 10px #FFA500; }
            100% { box-shadow: 0px 0px 30px 10px #FF69B4; }
        }

        /* Главный контент */
        #app-content {
            padding: 20px;
            padding-top: 60px; /* Отступ сверху для безопасной зоны */
            overflow-y: auto; /* Добавлено для скроллинга */
            height: calc(100vh - 60px); /* Высота контента с учетом navbar */
        }

        /* Профиль пользователя */
        .profile {
            display: flex;
            align-items: center;
            padding: 20px;
        }

        .avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #1DB954;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            color: #FFFFFF;
            margin-right: 15px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
        }
        .user-info h2, .user-info p {
            margin: 0;
        }

        /* Остаток по тарифу */
        .balance-section {
            text-align: center;
            margin-top: 30px;
        }

        #no-tariff-banner {
            background-color: #FF3B30;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            cursor: pointer;
        }

        #balance-info h1 {
            font-size: 48px;
            margin: 0;
        }

        #balance-info p {
            margin: 5px 0;
        }

        /* Статус */
        #status {
            color: #FF3B30; /* Красный по умолчанию (Неактивен) */
            font-weight: bold;
        }

        #status.active {
            color: #4CD964; /* Зеленый (Активен) */
        }

        /* Навигационная панель */
        .navbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1E1E1E;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }

        .nav-button {
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 16px;
            flex-grow: 1;
            padding: 10px 0;
            cursor: pointer;
            position: relative;
        }

        .nav-button.active {
            border-top: 2px solid #1DB954;
            color: #1DB954;
        }

        .notification-counter {
            display: inline-block;
            background-color: red;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: 5px;
            position: absolute;
            top: 5px;
            right: 15px;
        }

        /* Переключатель */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            background-color: #ccc;
            border-radius: 34px;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CD964;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        /* Страница настроек */
        .settings {
            padding: 20px;
            padding-top: 60px;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            cursor: pointer;
            position: relative;
        }

        /* Кнопка "Назад" */
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 24px;
            cursor: pointer;
            z-index: 2;
        }

        /* Секция тарифов */
        .tariff-card {
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .tariff-card:hover {
            background-color: #2A2A2A;
        }

        .tariff-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #333333;
            margin-right: 15px;
            flex-shrink: 0;
            overflow: hidden;
        }

        .tariff-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tariff-info {
            flex-grow: 1;
        }

        .tariff-info h3 {
            margin: 0;
            font-size: 18px;
        }

        .tariff-info p {
            margin: 5px 0;
            color: #AAAAAA;
        }

        .tariff-price {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        .tariff-action {
            margin-left: 10px;
        }

        .tariff-button {
            padding: 10px 15px;
            background-color: #1DB954;
            border: none;
            border-radius: 5px;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .tariff-button:hover {
            background-color: #17A44A;
        }

        .tariff-button:active {
            background-color: #14803D;
        }

        /* Дополнительные стили */
        h2, h1 {
            margin: 0;
        }

        /* Обеспечение безопасной зоны */
        #app-content {
            padding-bottom: env(safe-area-inset-bottom);
        }

        .navbar {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* История действий */
        .history-section {
            margin-top: 30px;
        }

        .history-item {
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .history-item:hover {
            background-color: #2A2A2A;
        }

        .history-item h3 {
            margin: 0;
            font-size: 16px;
        }

        .history-item p {
            margin: 5px 0;
            color: #AAAAAA;
            font-size: 14px;
        }

        /* Уведомление */
        .notification-banner {
            position: fixed;
            top: 10%;
            left: 5%;
            right: 5%;
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateY(-100%);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .notification-banner.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification-banner p {
            margin: 5px 0;
        }

        .notification-accept-button {
            color: #1DB954;
            font-weight: bold;
            cursor: pointer;
            float: right;
        }

        /* Страница уведомлений */
        .notifications-list {
            padding: 20px;
            padding-top: 60px;
        }

        .notification-item {
            background-color: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            cursor: pointer;
        }

        .notification-item:hover {
            background-color: #2A2A2A;
        }

        .notification-item h3 {
            margin: 0;
            font-size: 16px;
        }

        .notification-item p {
            margin: 5px 0;
            color: #AAAAAA;
            font-size: 14px;
        }

        .unread-indicator {
            position: absolute;
            top: 10px;
            right: 15px;
            background-color: red;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 12px;
        }

        /* Попап для подробной информации */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .popup-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1E1E1E;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 400px;
            overflow: hidden;
        }

        .popup-content h3 {
            margin-top: 0;
        }

        .popup-close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: #FFFFFF;
            font-size: 24px;
            cursor: pointer;
        }

        .popup-content a {
            color: #1E90FF;
            text-decoration: none;
        }

        .popup-content a:hover {
            text-decoration: underline;
        }

        /* Кнопка "Прочитать все" */
        .mark-all-read-button {
            padding: 10px 15px;
            background-color: #1DB954;
            border: none;
            border-radius: 5px;
            color: #FFFFFF;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 20px;
        }

        .mark-all-read-button:hover {
            background-color: #17A44A;
        }

        .mark-all-read-button:active {
            background-color: #14803D;
        }

    </style>
</head>
<body>
    <!-- Анимация загрузки -->
    <div id="loader">
        <div class="spinner"></div>
    </div>

    <!-- Основной контент -->
    <div id="app" class="hidden">
        <!-- Плавная подсветка (градиент) -->
        <div id="gradient"></div>

        <!-- Контент приложения -->
        <div id="app-content">
            <!-- Здесь будет динамически меняться содержимое -->
        </div>

        <!-- Навигационная панель -->
        <div class="navbar">
            <button class="nav-button active" id="nav-home">Главная</button>
            <button class="nav-button" id="nav-tariffs">Тарифы</button>
            <!-- Удалена кнопка "История" -->
            <button class="nav-button" id="nav-profile">Профиль</button>
            <button class="nav-button" id="nav-settings">Настройки</button>
        </div>
    </div>

    <!-- Скрипт для логики приложения -->
    <script>

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
    // Проверка наличия Telegram Web App
    const tg = window.Telegram.WebApp;

    // Получаем данные пользователя
    const telegramUser = tg.initDataUnsafe.user;

    // Устанавливаем полноэкранный режим
    tg.expand();
    tg.requestFullscreen();

    // Получаем элементы DOM
    const loader = document.getElementById('loader');
    const app = document.getElementById('app');
    const appContent = document.getElementById('app-content');
    const gradientElem = document.getElementById('gradient');

    // Настройки пользователя
    let isHighlightEnabled = localStorage.getItem('isHighlightEnabled') === 'false' ? false : true;

    // Данные пользователя
    const userFirstName = telegramUser.first_name || 'Имя';
    const userLastName = telegramUser.last_name || '';
    const username = telegramUser.username ? '@' + telegramUser.username : '';
    const userPhoto = telegramUser.photo_url || '';
    const telegramId = telegramUser.id; // Идентификатор пользователя Telegram

    // Данные о пользователе из базы данных
    let userBalance = 0;
    let userStatus = 'Неактивен';
    let userTariff = '—';
    let userHistory = [];

    // Массив уведомлений
    let notifications = [];

    // Переменная с юзернеймом менеджера поддержки
    const managerUsername = 'https://t.me/mwii_boss'; // Замените на актуальный юзернейм

    // Функция получения данных пользователя с сервера
    function fetchUserData() {
        return fetch(`https://ВАШ_ДОМЕН/api/users/${telegramId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    // Пользователь не найден, создаем новую запись
                    createUser();
                } else {
                    userBalance = data.video_balance;
                    userStatus = data.subscription_status === 'active' ? 'Активен' : 'Неактивен';
                    userTariff = data.tariff_name || '—';
                    userHistory = data.history || [];
                }
            })
            .catch(error => {
                console.error('Ошибка при получении данных пользователя:', error);
            });
    }

    // Функция создания пользователя на сервере
    function createUser() {
        fetch('https://ВАШ_ДОМЕН/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                telegram_id: telegramId,
                first_name: userFirstName,
                last_name: userLastName,
                username: telegramUser.username,
                photo_url: userPhoto
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Пользователь создан:', data);
        })
        .catch(error => {
            console.error('Ошибка при создании пользователя:', error);
        });
    }

    // Функция обновления информации о тарифе
    function updateTariffInfo() {
        if (userBalance > 0) {
            userStatus = 'Активен';
        } else {
            userStatus = 'Неактивен';
            userTariff = '—';
        }
    }

    // Функция переключения подсветки
    function toggleHighlight() {
        if (isHighlightEnabled) {
            gradientElem.style.display = 'block';
        } else {
            gradientElem.style.display = 'none';
        }
    }

    // Функция обновления безопасных зон
    function updateSafeArea() {
        const topPadding = 20;
        const bottomPadding = 20;
        appContent.style.paddingTop = topPadding + 'px';
        appContent.style.paddingBottom = bottomPadding + 'px';
    }

    // Функция рендеринга главной страницы
    function renderHomePage() {
        updateTariffInfo();

        appContent.innerHTML = '';

        // Остаток по тарифу
        const balanceSection = document.createElement('div');
        balanceSection.className = 'balance-section';

        // Плашка при отсутствии тарифа
        if (userBalance === 0) {
            const noTariffBanner = document.createElement('div');
            noTariffBanner.id = 'no-tariff-banner';
            noTariffBanner.innerHTML = 'У вас не оформлен тариф. Перейдите в раздел <strong>"Тарифы"</strong>.';
            noTariffBanner.addEventListener('click', () => {
                document.getElementById('nav-tariffs').click();
            });
            balanceSection.appendChild(noTariffBanner);
        }

        // Информация о балансе
        const balanceInfo = document.createElement('div');
        balanceInfo.id = 'balance-info';

        const balanceElem = document.createElement('h1');
        balanceElem.id = 'balance';
        balanceElem.textContent = `${userBalance} видео`;
        balanceInfo.appendChild(balanceElem);

        const statusElem = document.createElement('p');
        statusElem.id = 'status';
        statusElem.textContent = userStatus;
        if (userStatus === 'Активен') {
            statusElem.classList.add('active');
        }
        balanceInfo.appendChild(statusElem);

        const tariffNameElem = document.createElement('p');
        tariffNameElem.id = 'tariff-name';
        tariffNameElem.textContent = `Тариф: ${userTariff}`;
        balanceInfo.appendChild(tariffNameElem);

        balanceSection.appendChild(balanceInfo);

        appContent.appendChild(balanceSection);

        // Раздел "История"
        const historySection = document.createElement('div');
        historySection.className = 'history-section';

        const historyTitle = document.createElement('h2');
        historyTitle.textContent = 'История';
        historySection.appendChild(historyTitle);

        if (userHistory.length === 0) {
            const emptyMessage = document.createElement('p');
            emptyMessage.textContent = 'Пока нет действий.';
            historySection.appendChild(emptyMessage);
        } else {
            userHistory.forEach(item => {
                const actionItem = document.createElement('div');
                actionItem.className = 'history-item';

                const itemTitle = document.createElement('h3');
                if (item.action_type === 'download') {
                    itemTitle.textContent = `Скачано видео: ${item.details.title}`;
                } else if (item.action_type === 'subscription') {
                    itemTitle.textContent = `Оформлен тариф: ${item.details.tariff_name}`;
                } else if (item.action_type === 'publication') {
                    itemTitle.textContent = `Публикация в группе: ${item.details.group_name}`;
                }
                actionItem.appendChild(itemTitle);

                const itemDate = document.createElement('p');
                itemDate.textContent = `Дата: ${item.timestamp}`;
                actionItem.appendChild(itemDate);

                // Добавляем обработчик клика для отображения подробной информации
                actionItem.addEventListener('click', () => {
                    showActionDetails(item);
                });

                historySection.appendChild(actionItem);
            });
        }

        appContent.appendChild(historySection);
    }

    // Функция отображения подробной информации о действии
    function showActionDetails(item) {
        // Создаем затемненный фон
        const overlay = document.createElement('div');
        overlay.className = 'popup-overlay';
        overlay.addEventListener('click', () => {
            overlay.remove();
        });

        // Создаем окно попапа
        const popup = document.createElement('div');
        popup.className = 'popup-content';
        popup.addEventListener('click', (e) => {
            e.stopPropagation(); // Останавливаем всплытие события, чтобы клик внутри попапа не закрывал его
        });

        // Кнопка закрытия
        const closeButton = document.createElement('button');
        closeButton.className = 'popup-close-button';
        closeButton.innerHTML = '&times;';
        closeButton.addEventListener('click', () => {
            overlay.remove();
        });
        popup.appendChild(closeButton);

        if (item.action_type === 'download') {
            const title = document.createElement('h3');
            title.textContent = `Скачанное видео: ${item.details.title}`;
            popup.appendChild(title);

            const source = document.createElement('p');
            source.textContent = `Источник: ${item.details.source}`;
            popup.appendChild(source);

            const link = document.createElement('p');
            link.innerHTML = `Ссылка: <a href="${item.details.link}" target="_blank">${item.details.link}</a>`;
            popup.appendChild(link);

            const date = document.createElement('p');
            date.textContent = `Дата скачивания: ${item.timestamp}`;
            popup.appendChild(date);
        } else if (item.action_type === 'subscription') {
            const title = document.createElement('h3');
            title.textContent = `Тариф: ${item.details.tariff_name}`;
            popup.appendChild(title);

            const quantity = document.createElement('p');
            quantity.textContent = `Количество видео: ${item.details.quantity}`;
            popup.appendChild(quantity);

            const price = document.createElement('p');
            price.textContent = `Цена: ${item.details.price}`;
            popup.appendChild(price);

            const date = document.createElement('p');
            date.textContent = `Дата оформления: ${item.timestamp}`;
            popup.appendChild(date);
        } else if (item.action_type === 'publication') {
            const title = document.createElement('h3');
            title.textContent = `Публикация в группе`;
            popup.appendChild(title);

            const groupName = document.createElement('p');
            groupName.textContent = `Название группы: ${item.details.group_name}`;
            popup.appendChild(groupName);

            const date = document.createElement('p');
            date.textContent = `Дата публикации: ${item.timestamp}`;
            popup.appendChild(date);
        }

        overlay.appendChild(popup);
        document.body.appendChild(overlay);
    }

    // Функция рендеринга страницы "Тарифы"
    function renderTariffsPage() {
        appContent.innerHTML = '';

        const tariffsDiv = document.createElement('div');
        tariffsDiv.style.padding = '20px';
        tariffsDiv.style.paddingTop = '60px';

        const title = document.createElement('h2');
        title.textContent = 'Тарифы';
        title.style.marginBottom = '20px';
        tariffsDiv.appendChild(title);

        // Массив тарифов
        const tariffs = [
            {
                name: 'Пробный',
                description: 'Для скачивания доступно 100 видео',
                price: '399₽',
                image: '', // Добавьте ссылки на изображения тарифов
                action: 'Оформить',
                quantity: 100
            },
            {
                name: 'Новичок',
                description: 'Для скачивания доступно 500 видео',
                price: '1799₽',
                image: '',
                action: 'Оформить',
                quantity: 500
            },
            {
                name: 'Любитель',
                description: 'Для скачивания доступно 1000 видео',
                price: '2999₽',
                image: '',
                action: 'Оформить',
                quantity: 1000
            },
            {
                name: 'Профи',
                description: 'Для скачивания доступно 2000 видео',
                price: '5499₽',
                image: '',
                action: 'Оформить',
                quantity: 2000
            },
            {
                name: 'Бизнес',
                description: 'Для скачивания доступно 3000 видео',
                price: '6999₽',
                image: '',
                action: 'Оформить',
                quantity: 3000
            },
            {
                name: 'Бизнес VIP',
                description: 'Для скачивания доступно более 3000 видео',
                price: 'По договоренности',
                image: '',
                action: 'Связаться',
                quantity: 5000 // Предположим
            }
        ];

        tariffs.forEach(tariff => {
            const card = document.createElement('div');
            card.className = 'tariff-card';

            const image = document.createElement('div');
            image.className = 'tariff-image';
            // Если есть картинка, установить как фон
            if (tariff.image) {
                const img = document.createElement('img');
                img.src = tariff.image;
                image.appendChild(img);
            }
            card.appendChild(image);

            const info = document.createElement('div');
            info.className = 'tariff-info';

            const name = document.createElement('h3');
            name.textContent = tariff.name;
            info.appendChild(name);

            const description = document.createElement('p');
            description.textContent = tariff.description;
            info.appendChild(description);

            const price = document.createElement('div');
            price.className = 'tariff-price';
            price.textContent = tariff.price;
            info.appendChild(price);

            card.appendChild(info);

            const actionDiv = document.createElement('div');
            actionDiv.className = 'tariff-action';

            const button = document.createElement('button');
            button.className = 'tariff-button';
            button.textContent = tariff.action;
            button.addEventListener('click', () => {
                if (tariff.action === 'Связаться') {
                    // Открыть чат с менеджером
                    tg.sendData(JSON.stringify({action: 'contact_manager', username: managerUsername}));
                } else {
                    // Активировать тариф
                    startPayment(tariff);
                }
            });
            actionDiv.appendChild(button);

            card.appendChild(actionDiv);

            tariffsDiv.appendChild(card);
        });

        appContent.appendChild(tariffsDiv);
    }

    // Функция для активации тарифа
    function startPayment(tariff) {
        // Проверяем, нет ли уже активного тарифа
        fetch(`https://ВАШ_ДОМЕН/api/users/${telegramId}`)
            .then(response => response.json())
            .then(userData => {
                if (userData.subscription_status === 'active') {
                    alert('У вас уже есть активный тариф.');
                    navigateTo('nav-home');
                    return;
                } else {
                    // Активируем тариф
                    activateTariff(tariff);
                }
            })
            .catch(error => {
                console.error('Ошибка при проверке тарифа:', error);
            });
    }

    // Функция активации тарифа на сервере
    function activateTariff(tariff) {
        fetch(`https://ВАШ_ДОМЕН/api/users/${telegramId}/activate_tariff`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tariff_name: tariff.name,
                video_balance: tariff.quantity,
                price: tariff.price
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Tariff activated') {
                alert('Тариф успешно активирован!');
                // Обновляем данные пользователя
                fetchUserData().then(() => {
                    navigateTo('nav-home');
                });
            } else {
                alert('Ошибка при активации тарифа.');
            }
        })
        .catch(error => {
            console.error('Ошибка при активации тарифа:', error);
        });
    }

    // Функция рендеринга страницы "Профиль"
    function renderProfilePage() {
        appContent.innerHTML = '';

        const profileDiv = document.createElement('div');
        profileDiv.style.padding = '20px';
        profileDiv.style.paddingTop = '60px';

        const profileSection = document.createElement('div');
        profileSection.className = 'profile';

        const avatarElem = document.createElement('div');
        avatarElem.className = 'avatar';

        if (userPhoto) {
            const img = document.createElement('img');
            img.src = userPhoto;
            avatarElem.appendChild(img);
        } else {
            avatarElem.textContent = userFirstName.charAt(0).toUpperCase();
        }

        profileSection.appendChild(avatarElem);

        const userInfoDiv = document.createElement('div');
        userInfoDiv.className = 'user-info';

        const nameElem = document.createElement('h2');
        nameElem.textContent = `${userFirstName} ${userLastName}`.trim();
        userInfoDiv.appendChild(nameElem);

        const usernameElem = document.createElement('p');
        usernameElem.textContent = username;
        userInfoDiv.appendChild(usernameElem);

        profileSection.appendChild(userInfoDiv);

        profileDiv.appendChild(profileSection);

        appContent.appendChild(profileDiv);
    }

    // Функция рендеринга страницы "Настройки"
    function renderSettingsPage() {
        appContent.innerHTML = '';

        const settingsDiv = document.createElement('div');
        settingsDiv.className = 'settings';

        // Настройка "Подсветка"
        const highlightSetting = document.createElement('div');
        highlightSetting.className = 'settings-item';

        const settingLabel = document.createElement('span');
        settingLabel.textContent = 'Подсветка';

        const switchLabel = document.createElement('label');
        switchLabel.className = 'switch';

        const switchInput = document.createElement('input');
        switchInput.type = 'checkbox';
        switchInput.checked = isHighlightEnabled;
        switchInput.addEventListener('change', () => {
            isHighlightEnabled = switchInput.checked;
            localStorage.setItem('isHighlightEnabled', isHighlightEnabled);
            toggleHighlight();
        });

        const switchSlider = document.createElement('span');
        switchSlider.className = 'slider';

        switchLabel.appendChild(switchInput);
        switchLabel.appendChild(switchSlider);

        highlightSetting.appendChild(settingLabel);
        highlightSetting.appendChild(switchLabel);

        settingsDiv.appendChild(highlightSetting);

        // Добавляем плашку "Поддержка"
        const supportSetting = document.createElement('div');
        supportSetting.className = 'settings-item';
        supportSetting.style.cursor = 'pointer';

        const supportLabel = document.createElement('span');
        supportLabel.textContent = 'Поддержка';

        supportSetting.appendChild(supportLabel);

        // Добавляем обработчик события для открытия чата с менеджером
        supportSetting.addEventListener('click', () => {
            tg.sendData(JSON.stringify({action: 'contact_manager', username: managerUsername}));
        });

        settingsDiv.appendChild(supportSetting);

        appContent.appendChild(settingsDiv);
    }

    // Навигация
    function navigateTo(pageId) {
        appContent.innerHTML = '';

        // Добавляем кнопку "Назад" для страниц кроме главной
        if (pageId !== 'nav-home') {
            const backButton = document.createElement('button');
            backButton.className = 'back-button';
            backButton.innerHTML = '←';
            backButton.addEventListener('click', () => {
                navigateTo('nav-home');
                document.getElementById('nav-home').classList.add('active');
                document.querySelectorAll('.nav-button').forEach(btn => {
                    if (btn.id !== 'nav-home') btn.classList.remove('active');
                });
            });
            appContent.appendChild(backButton);
        }

        switch (pageId) {
            case 'nav-home':
                renderHomePage();
                break;
            case 'nav-tariffs':
                renderTariffsPage();
                break;
            case 'nav-profile':
                renderProfilePage();
                break;
            case 'nav-settings':
                renderSettingsPage();
                break;
            default:
                renderHomePage();
        }
    }

    // Навигационные кнопки
    const navButtons = document.querySelectorAll('.nav-button');
    navButtons.forEach(button => {
        button.addEventListener('click', () => {
            navButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            navigateTo(button.id);
        });
    });

    // Изначально устанавливаем состояние подсветки
    toggleHighlight();

    // Обработка безопасных зон
    tg.onEvent('viewportChanged', updateSafeArea);

    // Получаем данные пользователя и отображаем приложение
    fetchUserData().then(() => {
        if (loader) loader.classList.add('hidden');
        if (app) app.classList.remove('hidden');
        navigateTo('nav-home');
    });
});
</script>
</body>
</html>
